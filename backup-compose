services:
  backup-surveillance:
    image: alpine:latest
    container_name: backup-surveillance
    environment:
      - PUID=1027
      - PGID=65536
      - TZ=Europe/Amsterdam
      - PI_USER=obakker
      - PI_IP=192.168.178.111 #Raspberry Pi backup server IP
      - PI_PATH=/home/obakker/backup/surveillance
    volumes:
      - /volume1/surveillance/rasberry:/watch/surveillance:ro
      - /volume1/docker/backup-keys:/root/.ssh:ro
      - /volume1/docker/backup/surveillance:/config
    command: >
      sh -c "
      apk add --no-cache rsync openssh-client inotify-tools &&
      echo 'Starting real-time surveillance backup monitor...' &&
      echo 'Watching: /watch/surveillance' &&
      echo 'Backing up to: $${PI_USER}@$${PI_IP}:$${PI_PATH}' &&
      inotifywait -m -r -e close_write --format '%w%f' /watch/surveillance | while read file; do
        echo \"[$$(date '+%Y-%m-%d %H:%M:%S')] New file detected: $$file\" &&
        rsync -avz --progress 
          -e 'ssh -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null' 
          \"$$file\" 
          $${PI_USER}@$${PI_IP}:$${PI_PATH}/ &&
        echo \"[$$(date '+%Y-%m-%d %H:%M:%S')] Successfully backed up: $$file\"
      done
      "
    network_mode: synobridge
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped
